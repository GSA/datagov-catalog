{% extends "base.html" %}

{% block title %}{{ organization.name }} - Organization - Data.gov{% endblock %}

{% block container_class %}grid-container-widescreen{% endblock %}

{% block content %}
<section class="organization-detail">
  <nav class="usa-breadcrumb" aria-label="Breadcrumbs">
    <ol class="usa-breadcrumb__list">
      <li class="usa-breadcrumb__list-item">
        <a class="usa-breadcrumb__link" href="{{ url_for('main.index') }}">Home</a>
      </li>
      <li class="usa-breadcrumb__list-item">
        <a class="usa-breadcrumb__link" href="{{ url_for('main.list_organizations') }}">Organizations</a>
      </li>
      <li class="usa-breadcrumb__list-item"> </li>
    </ol>
  </nav>

  <div class="usa-prose">
    <h1>{{ organization.name }}</h1>
  </div>

  <div class="grid-row grid-gap-lg margin-top-3">
    <div class="desktop:grid-col-9 tablet:grid-col">
      <div class="usa-summary-box" role="region" aria-label="Organization summary">
        <div class="usa-summary-box__body">
          <h2 class="usa-summary-box__heading">Overview</h2>
          <ul class="usa-summary-box__list">
            <li class="usa-summary-box__item">
              <strong>Type:</strong> {{ organization.organization_type or "Not specified" }}
            </li>
            <li class="usa-summary-box__item">
              <strong>Total datasets:</strong> {{ organization.total_datasets }}
            </li>
          </ul>
        </div>
      </div>
    </div>

    <div class="desktop:grid-col-3 tablet:grid-col">
      <div class="display-flex flex-column flex-align-center flex-justify-center height-full">
        {% if organization.logo %}
        <img src="{{ organization.logo }}" alt="{{ organization.name }} logo" class="org-detail-logo">
        {% else %}
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="org-detail-logo">->
          <path d="M320 64C302.3 64 288 78.3 288 96C288 96.9 288 97.8 288.1 98.6C207.6 112 144.1 175.5 130.6 256L128 256C110.3 256 96 270.3 96 288C96 305.7 110.3 320 128 320L128 480L76.8 518.4C68.7 524.4 64 533.9 64 544C64 561.7 78.3 576 96 576L544 576C561.7 576 576 561.7 576 544C576 533.9 571.3 524.4 563.2 518.4L512 480L512 320C529.7 320 544 305.7 544 288C544 270.3 529.7 256 512 256L509.3 256C495.8 175.6 432.3 112.1 351.8 98.6C351.9 97.7 351.9 96.9 351.9 96C351.9 78.3 337.6 64 319.9 64zM400 320L464 320L464 480L400 480L400 320zM288 480L288 320L352 320L352 480L288 480zM176 320L240 320L240 480L176 480L176 320z"></path></svg>
        {% endif %}
      </div>
    </div>
  </div>

  {% if organization.description %}
  <section class="organization-description usa-prose margin-top-4">
    <h2>Description</h2>
    <p>{{ organization.description }}</p>
  </section>
  {% endif %}


  <section class="organization-datasets">
    <div class="grid-row grid-gap-lg margin-top-2">
      <div class="desktop:grid-col-9 tablet:grid-col">
        <form method="get" action="{{ url_for('main.organization_detail', slug=organization_slug_or_id) }}" class="usa-form" id="main-search-form">
            <div class="grid-row grid-gap-1 flex-align-end">
                <div class="grid-col-fill">
                    <label class="usa-sr-only" for="search-query">Search within organization</label>
                    <input class="usa-input margin-0" id="search-query" name="q" type="text" value="{{ dataset_search_query }}"
                        placeholder="Search datasets..." autofocus>
                    {% for keyword in keywords %}
                    <input type="hidden" name="keyword" value="{{ keyword }}">
                    {% endfor %}
                    {% if spatial_filter %}
                    <input type="hidden" name="spatial_filter" value="{{ spatial_filter }}">
                    {% endif %}
                    <input type="hidden" name="sort" value="{{ selected_sort }}">
                </div>
                <div class="grid-col-auto">
                    <button type="submit" class="usa-button margin-0">
                        <i class="fa fa-search" aria-hidden="true"></i>
                        <span class="margin-left-05">Search</span>
                    </button>
                </div>
            </div>
        </form>

        {% if datasets %}
        <div class="usa-prose">
          {% if dataset_search_query %}
          <p class="text-base-dark">
            {% if num_matches < 2 %}
                Found <strong>{{ num_matches }}</strong> dataset matching "{{ dataset_search_query }}".
            {% elif num_matches < 10000 %}
                Found <strong>{{ num_matches }}</strong> datasets matching "{{ dataset_search_query }}".
            {% else %}
                Found over <strong>{{ num_matches }}</strong> datasets matching "{{ dataset_search_query }}".
            {% endif %}
          </p>
          {% endif %}
        </div>
        
        <div class="margin-top-3">
          <ul class="usa-collection organization-datasets__list">
            {% include 'components/dataset_results_organization.html' %}
          </ul>
        </div>
        {% else %}
        <div class="usa-alert usa-alert--info margin-top-3">
          <div class="usa-alert__body">
            <p class="usa-alert__text">
              No datasets found{% if dataset_search_query %} matching "{{ dataset_search_query }}"{% endif %}. Try adjusting your search terms or filters.
            </p>
          </div>
        </div>
        {% endif %}

      </div>

      <aside class="desktop:grid-col-3 tablet:grid-col margin-top-3">
        <form class="usa-form" method="get"
          action="{{ url_for('main.organization_detail', slug=organization_slug_or_id) }}" id="filter-form">
            <input type="hidden" name="q" value="{{ dataset_search_query }}">

            <div class="margin-bottom-4">
                <label class="usa-label" for="sort-select">Sort by</label>
                <select class="usa-select" name="sort" id="sort-select" onchange="this.form.submit()">
                    <option value="relevance" {% if selected_sort == 'relevance' %}selected{% endif %}>Relevance</option>
                    <option value="popularity" {% if selected_sort == 'popularity' %}selected{% endif %}>Popularity</option>
                </select>
            </div>

            <!-- Keyword Filter Section -->
            <div class="usa-accordion usa-accordion--bordered margin-bottom-2">
                <h3 class="usa-accordion__heading">
                    <button type="button" class="usa-accordion__button" aria-expanded="true" aria-controls="filter-keywords">
                        Keywords
                    </button>
                </h3>
                <div id="filter-keywords" class="usa-accordion__content usa-prose">
                    <div class="keyword-autocomplete">
                        <label class="usa-label" for="keyword-input">
                            Filter by keyword <br>
                            <span class="usa-hint">Start typing to see suggestions</span>
                        </label>
                        <input
                            type="text"
                            id="keyword-input"
                            class="keyword-autocomplete__input usa-input"
                            placeholder="Type a keyword..."
                            autocomplete="off"
                            aria-autocomplete="list"
                            aria-controls="keyword-suggestions"
                            aria-expanded="false"
                        >
                        <div id="keyword-suggestions" class="keyword-suggestions" role="listbox"></div>

                        <div id="keyword-chips" class="keyword-chips" role="list" aria-label="Selected keywords"></div>

                        {% if suggested_keywords and not keywords %}
                        <div id="suggested-keywords" class="suggested-keywords margin-top-2">
                            <p class="text-base-dark margin-bottom-1"><strong>Popular keywords:</strong></p>
                            <div class="suggested-keywords__list">
                                {% for keyword in suggested_keywords %}
                                <button type="button" class="tag-link tag-link--suggested" data-keyword="{{ keyword }}">
                                    {{ keyword }}
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Geographic Filter Section -->
            <div class="usa-accordion usa-accordion--bordered">
                <h3 class="usa-accordion__heading">
                    <button type="button" class="usa-accordion__button"
                      aria-expanded="true" aria-controls="filter-geography">
                        Geographic Area
                    </button>
                </h3>
                <div id="filter-geography" class="usa-accordion__content usa-prose">
                    <div class="keyword-autocomplete">
                        <label id="geography-input-label" class="usa-label" for="geography-input">
                          Filter by Geography <br>
                            <span class="usa-hint">Start typing to see suggestions</span>
                        </label>
                        <input
                            type="text"
                            id="geography-input"
                            class="keyword-autocomplete__input usa-input"
                            placeholder="Type a place..."
                            autocomplete="off"
                            aria-autocomplete="list"
                            aria-controls="geography-suggestions"
                            aria-expanded="false"
                        >
                        <div id="geography-suggestions" class="keyword-suggestions" role="listbox"></div>

                    </div>
                    <div id="geography-map" style="height: 220px; border-radius: 4px; overflow: hidden;"></div>
                </div>
            </div>

            <!-- Spatial Data Filter Section -->
            <div class="usa-accordion usa-accordion--bordered">
                <h3 class="usa-accordion__heading">
                    <button type="button" class="usa-accordion__button" aria-expanded="true" aria-controls="filter-spatial">
                        Spatial Data
                    </button>
                </h3>
                <div id="filter-spatial" class="usa-accordion__content usa-prose">
                    <fieldset class="usa-fieldset">
                        <div class="usa-radio">
                            <input class="usa-radio__input" id="filter-spatial-all" type="radio" name="spatial_filter" value=""
                                {% if not spatial_filter %}checked{% endif %}>
                            <label class="usa-radio__label" for="filter-spatial-all">All datasets</label>
                        </div>
                        <div class="usa-radio">
                            <input class="usa-radio__input" id="filter-spatial-geo" type="radio" name="spatial_filter" value="geospatial"
                                {% if spatial_filter == 'geospatial' %}checked{% endif %}>
                            <label class="usa-radio__label" for="filter-spatial-geo">Geospatial only</label>
                        </div>
                        <div class="usa-radio">
                            <input class="usa-radio__input" id="filter-spatial-non-geo" type="radio" name="spatial_filter" value="non-geospatial"
                                {% if spatial_filter == 'non-geospatial' %}checked{% endif %}>
                            <label class="usa-radio__label" for="filter-spatial-non-geo">Non-geospatial only</label>
                        </div>
                    </fieldset>
                </div>
            </div>

        </form>
      </aside>
    </div>
  </section>
</section>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/filter_form_auto_submit.js') }}"></script>
<script src="{{ url_for('static', filename='js/filters_autocomplete.js') }}"></script>
<script src="{{ url_for('static', filename='js/geography_autocomplete.js') }}"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{% endblock %}
