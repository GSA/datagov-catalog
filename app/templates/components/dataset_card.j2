{% macro dataset_card(dataset, from_hint='', result_number=None, sort_value=None, allow_distance=false) -%}
{% set dataset_meta = dataset.get('dcat', {}) if dataset.get('dcat') else {} %}
{% set dataset_title = dataset_meta.get('title') or dataset.get('slug') or dataset.get('id') %}
{% set dataset_identifier = dataset.get('slug') or dataset.get('id') %}
{% set updated_display = dataset_meta.get('modified') %}
{% set view_count = dataset.get('popularity') %}
{% set sort_values = dataset.get('_sort') %}
{% set distance_km = none %}
{% if allow_distance %}
  {% if dataset.get('_distance_km') is not none %}
    {% set distance_km = dataset.get('_distance_km') %}
  {% elif sort_value == 'distance' and sort_values %}
    {% set distance_km = sort_values[0] %}
  {% endif %}
{% endif %}

{% autoescape true %}

<li class="usa-collection__item organization-datasets__item margin-0">
  <div class="organization-datasets__body">
    <div class="dataset-org-banner organization-datasets__body--{{ dataset.organization.organization_type | format_gov_type }}">
      {% if result_number is not none %}
      <span class="dataset-org-banner__rank">#{{ result_number }}</span>
      {% endif %}
      <span class="dataset-org-banner__type">{{ dataset.organization.organization_type | format_gov_type(lower=false) }}</span>
    </div>
      <div class="dataset-content">
          <div class="display-flex flex-align-center flex-wrap margin-bottom-05 organization-datasets__heading">
              <h3 class="usa-collection__heading margin-0">
                  <a class="usa-link"
                      {% if from_hint %}
                      href="{{ url_for('main.dataset_detail_by_slug_or_id', slug_or_id=dataset_identifier, from_hint=from_hint) }}">
                      {% else %}
                      href="{{ url_for('main.dataset_detail_by_slug_or_id', slug_or_id=dataset_identifier) }}">
                      {% endif %}

                      {{ dataset_title }}
                  </a>
                  {% if view_count is not none and view_count >= 100 %}
                    <i class="fa-solid fa-arrow-trend-up"></i>
                  {% endif %}
              </h3>
          </div>
          <ul class="usa-collection__meta">
              <li class="usa-collection__meta-item">
                  <strong>Organization:</strong>
                  <a class="usa-link"
                      href="{{ url_for('main.organization_detail', slug=dataset.organization.slug) }}">
                      {{ dataset.organization.name }}
                  </a>
              </li>
              {% if updated_display %}
              <li class="usa-collection__meta-item">
                  <strong>Updated:</strong> {{ updated_display or 'Not available' }}
              </li>
              {% endif %}
          </ul>
          <p class="usa-collection__description">
              {{ dataset_meta.get('description', 'No description available.') | remove_html_tags | truncate(200) }}
          </p>
          {% if dataset.dcat.distribution %}
          <ul class="dataset-resources unstyled">
              {% for resource in dataset.dcat.distribution[:6] %}
              <li>
                  <a href="{{ resource.accessURL or url_for('main.dataset_detail_by_slug_or_id', slug_or_id=dataset_identifier) }}" class="label label-default text-uppercase" data-format="{{ resource.format | default('HTML') | lower }}" data-organization="{{ dataset.organization.name }}">{{ resource.format | default('HTML') | lower }}</a>
              </li>
              {% endfor %}
              {% if dataset.dcat.distribution|length > 6 %}
              <li class="text-base-light">
                  <a class="usa-link"
                      href="{{ url_for('main.dataset_detail_by_slug_or_id', slug_or_id=dataset_identifier) }}">
                      +{{ dataset.dcat.distribution|length - 6 }} more
                  </a>
              </li>
              {% endif %}
          </ul>
          {% endif %}
          {% set search_score = dataset.get('_score') %}
          {% if search_score is not none or view_count is not none or distance_km is not none %}
          <div class="margin-top-1">
              <small class="text-base-dark">
                  {% if search_score is not none %}
                    {% if view_count is not none %}
                      Search relevance: {{ '%.2f' % search_score }} | Views last month: {{ view_count }}
                    {% else %}
                      Search relevance: {{ '%.2f' % search_score }}
                    {% endif %}
                  {% else %}
                    {% if view_count is not none %}
                      Views last month: {{ view_count }}
                    {% endif %}
                  {% endif %}
                  {% if distance_km is not none %}
                    {% set distance_mi = distance_km * 0.621371 %}
                    {% if search_score is not none or view_count is not none %} | {% endif %}
                    Distance: {{ '%.1f' % distance_mi }} mi
                  {% endif %}
              </small>
          </div>
          {% endif %}
      </div>
  </div>
</li>
{% endautoescape %}
{% endmacro -%}
