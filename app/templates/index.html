{% extends "base.html" %}

{% import 'components/dataset_card.j2' as dataset_card %}

{% block title %}Catalog - Data.gov{% endblock %}

{% block content %}
<div class="grid-row">
    <div class="grid-col-12">
        <div class="usa-prose text-center margin-bottom-4">
            <h1>Search Data.gov</h1>
        </div>
    </div>
</div>

<div class="grid-row grid-gap-lg">
    <!-- Main search and results area -->
    <div class="tablet:grid-col-12 desktop:grid-col-9">
        <form method="GET" action="{{ url_for('main.index') }}" class="usa-form">

            <label class="usa-label" for="search-query">Search datasets</label>
            <div class="grid-row grid-gap-1 flex-align-end">
                <div class="grid-col-fill">
                    <input class="usa-input margin-0" id="search-query" name="q" type="text" 
                        placeholder="Search Data.gov..." autofocus value="{{ query }}">
                    {% for org_type in org_types %}
                    <input type="hidden" name="org_type" value="{{ org_type }}">
                    {% endfor %}
                    {% if org_id %}
                    <input type="hidden" name="org_id" value="{{ org_id }}">
                    {% endif %}
                    <input type="hidden" name="sort" value="{{ sort_by }}">
                </div>
                <div class="grid-col-auto">
                    <button type="submit" class="usa-button margin-0">
                        <i class="fa fa-search" aria-hidden="true"></i>
                        <span class="margin-left-05">Search</span>
                    </button>
                </div>
            </div>
        </form>

        <!-- Results Section -->
        {% if query %}
        <div id="search-results" class="margin-top-3">
            {% if datasets %}
            <div class="usa-prose">
                <p class="text-base-dark">
                {% if total < 2 %}
                    Found <strong>{{ total }}</strong> dataset{% if query %} matching "{{ query }}"{% endif %}.
                {% elif total < 10000 %}
                    Found <strong>{{ total }}</strong> datasets{% if query %} matching "{{ query }}"{% endif %}.
                {% else %}
                    Found more than <strong>{{ total }}</strong> datasets{% if query %} matching "{{ query }}"{% endif %}.
                    <!-- Advanced Search Tip -->
                    <div class="advanced-search-tip">
                        <div class="advanced-search-tip__title">ðŸ’¡ Advanced Search Tip</div>
                        <p class="advanced-search-tip__text">
                            Use quotes for exact phrases: <code>"flood zones"</code> | 
                            Use AND/OR for multiple terms: <code>crops AND agriculture</code> | 
                            Search by organization or tag to find related datasets
                        </p>
                    </div>
                {% endif %}
                </p>
            </div>

            <section class="organization-datasets margin-top-3">
                <ul class="usa-collection organization-datasets__list">
                  {% include 'components/dataset_results.html' %}
                </ul>
            </section>
            {% else %}
            <div class="usa-alert usa-alert--info margin-top-3">
                <div class="usa-alert__body">
                    <p class="usa-alert__text">
                        No datasets found matching "{{ query }}". Try adjusting your search terms or filters.
                    </p>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Sidebar for filters and sort -->
    <aside class="tablet:grid-col-12 desktop:grid-col-3">
        <form method="GET" action="{{ url_for('main.index') }}" id="filter-form">
            <input type="hidden" name="q" value="{{ query }}">

            <!-- Sort Section -->
            <div class="margin-bottom-4">
                <label class="usa-label" for="sort-select">Sort by</label>
                <select class="usa-select" name="sort" id="sort-select" onchange="this.form.submit()">
                    <option value="relevance" {% if sort_by == 'relevance' %}selected{% endif %}>Relevance</option>
                </select>
            </div>

            <!-- Filters Section -->
            <div class="usa-accordion usa-accordion--bordered">
                <h3 class="usa-accordion__heading">
                    <button type="button" class="usa-accordion__button" aria-expanded="true" aria-controls="filter-organization">
                        Organization Type
                    </button>
                </h3>
                <div id="filter-organization" class="usa-accordion__content usa-prose">
                    <fieldset class="usa-fieldset">
                        <div class="usa-checkbox">
                            <input class="usa-checkbox__input" id="filter-federal" type="checkbox" name="org_type" value="Federal Government"
                                {% if 'Federal Government' in org_types %}checked{% endif %}>
                            <label class="usa-checkbox__label" for="filter-federal">Federal Government</label>
                        </div>
                        <div class="usa-checkbox">
                            <input class="usa-checkbox__input" id="filter-city" type="checkbox" name="org_type" value="City Government"
                                {% if 'City Government' in org_types %}checked{% endif %}>
                            <label class="usa-checkbox__label" for="filter-city">City Government</label>
                        </div>
                        <div class="usa-checkbox">
                            <input class="usa-checkbox__input" id="filter-state" type="checkbox" name="org_type" value="State Government"
                                {% if 'State Government' in org_types %}checked{% endif %}>
                            <label class="usa-checkbox__label" for="filter-state">State Government</label>
                        </div>
                        <div class="usa-checkbox">
                            <input class="usa-checkbox__input" id="filter-county" type="checkbox" name="org_type" value="County Government"
                                {% if 'County Government' in org_types %}checked{% endif %}>
                            <label class="usa-checkbox__label" for="filter-county">County Government</label>
                        </div>
                        <div class="usa-checkbox">
                            <input class="usa-checkbox__input" id="filter-university" type="checkbox" name="org_type" value="University"
                                {% if 'University' in org_types %}checked{% endif %}>
                            <label class="usa-checkbox__label" for="filter-university">University</label>
                        </div>
                        <div class="usa-checkbox">
                            <input class="usa-checkbox__input" id="filter-tribal" type="checkbox" name="org_type" value="Tribal"
                                {% if 'Tribal' in org_types %}checked{% endif %}>
                            <label class="usa-checkbox__label" for="filter-tribal">Tribal</label>
                        </div>
                        <div class="usa-checkbox">
                            <input class="usa-checkbox__input" id="filter-nonprofit" type="checkbox" name="org_type" value="Non-Profit"
                                {% if 'Non-Profit' in org_types %}checked{% endif %}>
                            <label class="usa-checkbox__label" for="filter-nonprofit">Non-Profit</label>
                        </div>
                    </fieldset>
                </div>
            </div>

            <button type="submit" class="usa-button usa-button--outline width-full margin-top-2">
                Apply Filters
            </button>
        </form>
    </aside>
</div>
{% endblock %}
