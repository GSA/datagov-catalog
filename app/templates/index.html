{% extends "base.html" %}
{% from "components/filter_sidebar.html" import render_filter_sidebar %}

{% set page_title = "Catalog - Data.gov" %}
{% block title %}{{ page_title }}{% endblock %}

{% block head_extra %}
{% set meta_description = "The Home of the U.S. Government's Open Data" %}
{% set social_image = config.get('SOCIAL_IMAGE_URL') %}
{% set canonical_url = "https://catalog-beta.data.gov/" %}
<meta name="description" content="{{ meta_description }}">
<meta name="robots" content="index,follow">
<meta property="og:site_name" content="Data.gov">
<meta property="og:type" content="website">
<meta property="og:url" content="{{ canonical_url  }}">
<meta property="og:title" content="{{ page_title }}">
<meta property="og:description" content="{{ meta_description }}">
<meta property="og:image" content="{{ social_image }}">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:url" content="{{ canonical_url  }}">
<meta name="twitter:title" content="{{ page_title }}">
<meta name="twitter:description" content="{{ meta_description }}">
<meta name="twitter:image" content="{{ social_image }}">
{% endblock %}

{% block content %}

<div class="grid-row grid-gap-lg">
    <!-- Main search and results area -->
    <div class="tablet:grid-col-12 desktop:grid-col-9">
        <form method="GET" action="{{ url_for('main.index') }}" class="usa-form" id="main-search-form">

            <label class="usa-label" for="search-query"><b>Search datasets</b></label>
            <div class="grid-row grid-gap-1 flex-align-end margin-top-neg-1px">
                <div class="grid-col-fill">
                    <input class="usa-input margin-0" id="search-query" name="q" type="text"
                        placeholder="Search Data.gov..." autofocus value="{{ query }}">
                    {% for org_type in org_types %}
                    <input type="hidden" name="org_type" value="{{ org_type }}">
                    {% endfor %}
                    {% for keyword in keywords %}
                    <input type="hidden" name="keyword" value="{{ keyword }}">
                    {% endfor %}
                    {% if org_slug %}
                    <input type="hidden" name="org_slug" value="{{ org_slug }}">
                    {% endif %}
                    {% if spatial_filter %}
                    <input type="hidden" name="spatial_filter" value="{{ spatial_filter }}">
                    {% endif %}
                    <input type="hidden" name="sort" value="{{ sort_by }}">
                </div>
                <div class="grid-col-auto">
                    <button type="submit" class="usa-button margin-0">
                        <i class="fa fa-search" aria-hidden="true"></i>
                        <span class="margin-left-05">Search</span>
                    </button>
                </div>
            </div>
        </form>

        <!-- Results Section -->
        <div id="search-results" class="margin-top-3">
            {% if datasets %}
            <div class="usa-prose">
              {% if query or org_types or keywords or org_slug or spatial_filter or spatial_geometry %}
                <p class="text-base-dark">
                {%- if total < 2 -%}
                    Found <strong>{{ total }}</strong> dataset matching
                {%- elif total < 10000 -%}
                    Found <strong>{{ total }}</strong> datasets matching
                {%- else -%}
                    Found over <strong>{{ total }}</strong> datasets matching
                {%- endif %}
                {%- if query and (org_types or keywords or org_slug or spatial_filter or spatial_geometry) %} "{{ query }}" and filters.
                {%- elif query %} "{{ query }}".
                {%- else %} filters.
                {%- endif -%}
                </p>
                {% if total >= 10000 %}
                    <div class="advanced-search-tip">
                        <div class="advanced-search-tip__title">ðŸ’¡ Search Tips</div>
                        <p class="advanced-search-tip__text">
                            <strong>Quotes</strong> find exact phrases: <code>"flood zones"</code> |
                            <strong>OR</strong> finds either term: <code>crops OR agriculture</code> |
                            Searches dataset titles, descriptions, tags, and publishers
                        </p>
                    </div>
                {% endif %}
              {% else %}
                <p class="text-base-dark">
                <span class="text-heavy text-secondary font-sans-lg">{{ "{:,}".format(total) }}</span>
                datasets available on Data.gov.
                These are the most popular:
                </p>
              {% endif %}
            </div>

            <section class="organization-datasets margin-top-3">
                <ul class="usa-collection organization-datasets__list">
                  {% include 'components/dataset_results.html' %}
                </ul>
            </section>
            {% else %}
            <div class="usa-alert usa-alert--info margin-top-3">
                <div class="usa-alert__body">
                    <p class="usa-alert__text" id="no-datasets-alert">
                        No datasets found. Try adjusting your search terms or filters.
                    </p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Sidebar for filters and sort -->
    <aside class="tablet:grid-col-12 desktop:grid-col-3 margin-top-0">
        {{ render_filter_sidebar(
        form_action=url_for('main.index'),
        query_value=query,
        sort_value=sort_by,
        keywords=keywords,
        suggested_keywords=suggested_keywords,
        spatial_filter=spatial_filter,
        org_slug=org_slug,
        show_org_autocomplete=True,
        show_org_type_filters=True,
        org_types=org_types,
        selected_organization=selected_organization,
        suggested_organizations=suggested_organizations,
        contextual_keyword_counts=contextual_keyword_counts,
        contextual_org_counts=contextual_org_counts
        ) }}
    </aside>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/filter_form_auto_submit.js') }}"></script>
<script src="{{ url_for('static', filename='js/filters_autocomplete.js') }}"></script>
<script src="{{ url_for('static', filename='js/geography_autocomplete.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/vendor/leaflet.css') }}"/>
<script src="{{ url_for('static', filename='js/vendor/leaflet.js') }}"></script>
{% endblock %}
