{% extends "base.html" %}
{% from "components/filter_sidebar.html" import render_filter_sidebar %}

{% block title %}Catalog - Data.gov{% endblock %}

{% block content %}

<div class="grid-row grid-gap-lg">
    <!-- Main search and results area -->
    <div class="tablet:grid-col-12 desktop:grid-col-9">
        <form method="GET" action="{{ url_for('main.index') }}" class="usa-form" id="main-search-form">

            <label class="usa-label" for="search-query"><b>Search datasets</b></label>
            <div class="grid-row grid-gap-1 flex-align-end margin-top-neg-1px">
                <div class="grid-col-fill">
                    <input class="usa-input margin-0" id="search-query" name="q" type="text"
                        placeholder="Search Data.gov..." autofocus value="{{ query }}">
                    {% for org_type in org_types %}
                    <input type="hidden" name="org_type" value="{{ org_type }}">
                    {% endfor %}
                    {% for keyword in keywords %}
                    <input type="hidden" name="keyword" value="{{ keyword }}">
                    {% endfor %}
                    {% if org_slug %}
                    <input type="hidden" name="org_slug" value="{{ org_slug }}">
                    {% endif %}
                    {% if spatial_filter %}
                    <input type="hidden" name="spatial_filter" value="{{ spatial_filter }}">
                    {% endif %}
                    <input type="hidden" name="sort" value="{{ sort_by }}">
                </div>
                <div class="grid-col-auto">
                    <button type="submit" class="usa-button margin-0">
                        <i class="fa fa-search" aria-hidden="true"></i>
                        <span class="margin-left-05">Search</span>
                    </button>
                </div>
            </div>
        </form>

        <!-- Results Section -->
        <div id="search-results" class="margin-top-3">
            {% if datasets %}
            <div class="usa-prose">
              {% if query or org_types or keywords or org_slug or spatial_filter %}
                <p class="text-base-dark">
                {%- if total < 2 -%}
                    Found <strong>{{ total }}</strong> dataset matching
                {%- elif total < 10000 -%}
                    Found <strong>{{ total }}</strong> datasets matching
                {%- else -%}
                    Found over <strong>{{ total }}</strong> datasets matching
                {%- endif %}
                {%- if query and (org_types or keywords or org_slug or spatial_filter) %} "{{ query }}" and filters.
                {%- elif query %} "{{ query }}".
                {%- else %} filters.
                {%- endif -%}
                </p>
                {% if total >= 10000 %}
                    <div class="advanced-search-tip">
                        <div class="advanced-search-tip__title">ðŸ’¡ Search Tips</div>
                        <p class="advanced-search-tip__text">
                            <strong>Quotes</strong> find exact phrases: <code>"flood zones"</code> |
                            <strong>OR</strong> finds either term: <code>crops OR agriculture</code> |
                            Searches dataset titles, descriptions, tags, and publishers
                        </p>
                    </div>
                {% endif %}
              {% else %}
                <p class="text-base-dark">
                <span class="text-heavy text-secondary font-sans-lg">{{ "{:,}".format(total) }}</span>
                datasets available on Data.gov.
                These are the most popular:
                </p>
              {% endif %}
            </div>

            <section class="organization-datasets margin-top-3">
                <ul class="usa-collection organization-datasets__list">
                  {% include 'components/dataset_results.html' %}
                </ul>
            </section>
            {% else %}
            <div class="usa-alert usa-alert--info margin-top-3">
                <div class="usa-alert__body">
                    <p class="usa-alert__text">
                        No datasets found. Try adjusting your search terms or filters.
                    </p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Sidebar for filters and sort -->
    <aside class="tablet:grid-col-12 desktop:grid-col-3 margin-top-3">
        {{ render_filter_sidebar(
            form_action=url_for('main.index'),
            query_value=query,
            sort_value=sort_by,
            keywords=keywords,
            suggested_keywords=suggested_keywords,
            spatial_filter=spatial_filter,
            org_slug=org_slug,
            show_org_autocomplete=True,
            show_org_type_filters=True,
            org_types=org_types,
            selected_organization=selected_organization,
            suggested_organizations=suggested_organizations
        ) }}
    </aside>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/filter_form_auto_submit.js') }}"></script>
<script src="{{ url_for('static', filename='js/filters_autocomplete.js') }}"></script>
<script src="{{ url_for('static', filename='js/geography_autocomplete.js') }}"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{% endblock %}
