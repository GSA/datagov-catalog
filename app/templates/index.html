{% extends "base.html" %}

{% block title %}Catalog - Data.gov{% endblock %}

{% block content %}

<div class="grid-row grid-gap-lg">
    <!-- Main search and results area -->
    <div class="tablet:grid-col-12 desktop:grid-col-9">
        <form method="GET" action="{{ url_for('main.index') }}" class="usa-form" id="main-search-form">

            <label class="usa-label" for="search-query"><b>Search datasets</b></label>
            <div class="grid-row grid-gap-1 flex-align-end">
                <div class="grid-col-fill">
                    <input class="usa-input margin-0" id="search-query" name="q" type="text"
                        placeholder="Search Data.gov..." autofocus value="{{ query }}">
                    {% for org_type in org_types %}
                    <input type="hidden" name="org_type" value="{{ org_type }}">
                    {% endfor %}
                    {% for keyword in keywords %}
                    <input type="hidden" name="keyword" value="{{ keyword }}">
                    {% endfor %}
                    {% if org_id %}
                    <input type="hidden" name="org_id" value="{{ org_id }}">
                    {% endif %}
                    {% if spatial_filter %}
                    <input type="hidden" name="spatial_filter" value="{{ spatial_filter }}">
                    {% endif %}
                    <input type="hidden" name="sort" value="{{ sort_by }}">
                </div>
                <div class="grid-col-auto">
                    <button type="submit" class="usa-button margin-0">
                        <i class="fa fa-search" aria-hidden="true"></i>
                        <span class="margin-left-05">Search</span>
                    </button>
                </div>
            </div>
        </form>

        <!-- Results Section -->
        <div id="search-results" class="margin-top-3">
            {% if datasets %}
            <div class="usa-prose">
              {% if query or org_types or keywords or org_id or spatial_filter %}
                <p class="text-base-dark">
                {%- if total < 2 -%}
                    Found <strong>{{ total }}</strong> dataset matching
                {%- elif total < 10000 -%}
                    Found <strong>{{ total }}</strong> datasets matching
                {%- else -%}
                    Found over <strong>{{ total }}</strong> datasets matching
                {%- endif %}
                {%- if query and (org_types or keywords or org_id or spatial_filter) %} "{{ query }}" and filters.
                {%- elif query %} "{{ query }}".
                {%- else %} filters.
                {%- endif -%}
                </p>
                {% if total >= 10000 %}
                <div class="advanced-search-tip">
                    <div class="advanced-search-tip__title">ðŸ’¡ Advanced Search Tip</div>
                    <p class="advanced-search-tip__text">
                        Use quotes for exact phrases: <code>"flood zones"</code> | 
                        Use AND/OR for multiple terms: <code>crops AND agriculture</code> | 
                        Search by organization or tag to find related datasets
                    </p>
                </div>
                {% endif %}
              {% else %}
                <p class="text-base-dark">
                <span class="text-heavy text-secondary font-sans-lg">{{ "{:,}".format(total_datasets) }}</span>
                datasets available on Data.gov.
                These are the most popular:
                </p>
              {% endif %}
            </div>

            <section class="organization-datasets margin-top-3">
                <ul class="usa-collection organization-datasets__list">
                  {% include 'components/dataset_results.html' %}
                </ul>
            </section>
            {% else %}
            <div class="usa-alert usa-alert--info margin-top-3">
                <div class="usa-alert__body">
                    <p class="usa-alert__text">
                        No datasets found. Try adjusting your search terms or filters.
                    </p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Sidebar for filters and sort -->
    <aside class="tablet:grid-col-12 desktop:grid-col-3">
        <form method="GET" action="{{ url_for('main.index') }}" id="filter-form">
            <input type="hidden" name="q" value="{{ query }}">
            <!-- Sort Section -->
            <div class="margin-bottom-4">
                <label class="usa-label" for="sort-select">Sort by</label>
                <select class="usa-select" name="sort" id="sort-select" onchange="this.form.submit()">
                    <option value="relevance" {% if sort_by == 'relevance' %}selected{% endif %}>Relevance</option>
                    <option value="popularity" {% if sort_by == 'popularity' %}selected{% endif %}>Popularity</option>
                </select>
            </div>

            <!-- Keyword Filter Section -->
            <div class="usa-accordion usa-accordion--bordered margin-bottom-2">
                <h3 class="usa-accordion__heading">
                    <button type="button" class="usa-accordion__button" aria-expanded="true" aria-controls="filter-keywords">
                        Keywords
                    </button>
                </h3>
                <div id="filter-keywords" class="usa-accordion__content usa-prose">
                    <div class="keyword-autocomplete">
                        <label class="usa-label" for="keyword-input">
                            Filter by keyword <br>
                            <span class="usa-hint">Start typing to see suggestions</span>
                        </label>
                        <input 
                            type="text" 
                            id="keyword-input" 
                            class="keyword-autocomplete__input usa-input"
                            placeholder="Type a keyword..."
                            autocomplete="off"
                            aria-autocomplete="list"
                            aria-controls="keyword-suggestions"
                            aria-expanded="false"
                        >
                        <div id="keyword-suggestions" class="keyword-suggestions" role="listbox"></div>

                        <!-- Selected keywords chips -->
                        <div id="keyword-chips" class="keyword-chips" role="list" aria-label="Selected keywords"></div>

                        <!-- Suggested keywords (only shown when no keywords selected) -->
                        {% if suggested_keywords and not keywords %}
                        <div id="suggested-keywords" class="suggested-keywords margin-top-2">
                            <p class="text-base-dark margin-bottom-1"><strong>Popular keywords:</strong></p>
                            <div class="suggested-keywords__list">
                                {% for keyword in suggested_keywords %}
                                <button type="button" class="tag-link tag-link--suggested" data-keyword="{{ keyword }}">
                                    {{ keyword }}
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Organization Type Filter Section -->
            <div class="usa-accordion usa-accordion--bordered margin-bottom-2">
                <h3 class="usa-accordion__heading">
                    <button type="button" class="usa-accordion__button" aria-expanded="true" aria-controls="filter-organization">
                        Organization Type
                    </button>
                </h3>
                <div id="filter-organization" class="usa-accordion__content usa-prose">
                    <fieldset class="usa-fieldset">
                        <div class="usa-checkbox">
                            <input class="usa-checkbox__input" id="filter-federal" type="checkbox" name="org_type" value="Federal Government"
                                {% if 'Federal Government' in org_types %}checked{% endif %}>
                            <label class="usa-checkbox__label" for="filter-federal">Federal Government</label>
                        </div>
                        <div class="usa-checkbox">
                            <input class="usa-checkbox__input" id="filter-city" type="checkbox" name="org_type" value="City Government"
                                {% if 'City Government' in org_types %}checked{% endif %}>
                            <label class="usa-checkbox__label" for="filter-city">City Government</label>
                        </div>
                        <div class="usa-checkbox">
                            <input class="usa-checkbox__input" id="filter-state" type="checkbox" name="org_type" value="State Government"
                                {% if 'State Government' in org_types %}checked{% endif %}>
                            <label class="usa-checkbox__label" for="filter-state">State Government</label>
                        </div>
                        <div class="usa-checkbox">
                            <input class="usa-checkbox__input" id="filter-county" type="checkbox" name="org_type" value="County Government"
                                {% if 'County Government' in org_types %}checked{% endif %}>
                            <label class="usa-checkbox__label" for="filter-county">County Government</label>
                        </div>
                        <div class="usa-checkbox">
                            <input class="usa-checkbox__input" id="filter-university" type="checkbox" name="org_type" value="University"
                                {% if 'University' in org_types %}checked{% endif %}>
                            <label class="usa-checkbox__label" for="filter-university">University</label>
                        </div>
                        <div class="usa-checkbox">
                            <input class="usa-checkbox__input" id="filter-tribal" type="checkbox" name="org_type" value="Tribal"
                                {% if 'Tribal' in org_types %}checked{% endif %}>
                            <label class="usa-checkbox__label" for="filter-tribal">Tribal</label>
                        </div>
                        <div class="usa-checkbox">
                            <input class="usa-checkbox__input" id="filter-nonprofit" type="checkbox" name="org_type" value="Non-Profit"
                                {% if 'Non-Profit' in org_types %}checked{% endif %}>
                            <label class="usa-checkbox__label" for="filter-nonprofit">Non-Profit</label>
                        </div>
                    </fieldset>
                </div>
            </div>

            <!-- Geographic Filter Section -->
            <div class="usa-accordion usa-accordion--bordered">
                <h3 class="usa-accordion__heading">
                    <button type="button" class="usa-accordion__button"
                      aria-expanded="true" aria-controls="filter-geography">
                        Geographic Area
                    </button>
                </h3>
                <div id="filter-geography" class="usa-accordion__content usa-prose">
                    <div class="keyword-autocomplete">
                        <label id="geography-input-label" class="usa-label" for="geography-input">
                          Filter by Geography <br>
                            <span class="usa-hint">Start typing to see suggestions</span>
                        </label>
                        <input 
                            type="text" 
                            id="geography-input" 
                            class="keyword-autocomplete__input usa-input"
                            placeholder="Type a place..."
                            autocomplete="off"
                            aria-autocomplete="list"
                            aria-controls="geography-suggestions"
                            aria-expanded="false"
                        >
                        <div id="geography-suggestions" class="keyword-suggestions" role="listbox"></div>

                    </div>
                    <div id="geography-map" style="height: 220px; border-radius: 4px; overflow: hidden;"></div>
                </div>
            </div>

            <!-- Spatial Data Filter Section -->
            <div class="usa-accordion usa-accordion--bordered">
                <h3 class="usa-accordion__heading">
                    <button type="button" class="usa-accordion__button" aria-expanded="true" aria-controls="filter-spatial">
                        Spatial Data
                    </button>
                </h3>
                <div id="filter-spatial" class="usa-accordion__content usa-prose">
                    <fieldset class="usa-fieldset">
                        <div class="usa-radio">
                            <input class="usa-radio__input" id="filter-spatial-all" type="radio" name="spatial_filter" value=""
                                {% if not spatial_filter %}checked{% endif %}>
                            <label class="usa-radio__label" for="filter-spatial-all">All datasets</label>
                        </div>
                        <div class="usa-radio">
                            <input class="usa-radio__input" id="filter-spatial-geo" type="radio" name="spatial_filter" value="geospatial"
                                {% if spatial_filter == 'geospatial' %}checked{% endif %}>
                            <label class="usa-radio__label" for="filter-spatial-geo">Geospatial only</label>
                        </div>
                        <div class="usa-radio">
                            <input class="usa-radio__input" id="filter-spatial-non-geo" type="radio" name="spatial_filter" value="non-geospatial"
                                {% if spatial_filter == 'non-geospatial' %}checked{% endif %}>
                            <label class="usa-radio__label" for="filter-spatial-non-geo">Non-geospatial only</label>
                        </div>
                    </fieldset>
                </div>
            </div>

            <button type="submit" class="usa-button usa-button--outline width-full margin-top-2">
                Apply Filters
            </button>
        </form>
    </aside>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/keyword_autocomplete.js') }}"></script>
<script src="{{ url_for('static', filename='js/geography_autocomplete.js') }}"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{% endblock %}
