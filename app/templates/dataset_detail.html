{% extends "base.html" %}

{% set dataset_title = dataset.dcat.get('title') or dataset.slug or dataset.id %}
{% set dataset_identifier = dataset.slug or dataset.id %}
{% set organization_title = organization.name %}
{% set page_title = organization_title ~ ' - ' ~ dataset_title %}

{% block title %}{{ page_title }}{% endblock %}

{% block container_class %}grid-container-widescreen{% endblock %}

{% block datalayer %}
<script nonce="{{ csp_nonce() }}">
    window.dataLayer = window.dataLayer || [];

    // determine whether the user-agent is a bot
    const bot_regex = /(googlebot|bingbot|yahoo|y!j|yeti|bytespider|applebot|headlesschrome|facebook(bot|externalhit)?|baidu|petalbot|duckduckbot|slurp|semrush|ahrefs|mj12bot|dotbot|crawler|spider|bot)/i;
    let is_bot = false

    if (bot_regex.test(navigator.userAgent)) {
        is_bot = true
    }

    dataLayer.push({
        "nodeID": "{{ dataset.id }}",
        "contentType": "dataset",
        "language": "en",
        "homepageTest": "not_homepage",
        "basicPagesubType": "dataset",
        "Page_Type": "Dataset Page",
        "organization": "{{ organization.name if organization else 'Unknown' }}",
        "publisher": "{{ dataset.dcat.get('publisher', {}).get('name') }}",
        "is_bot": is_bot
    });
</script>
{% endblock %}

{% block head_extra %}
{% set description_value = dataset.dcat.get('description') %}
{% set cleaned_description = description_value | remove_html_tags | striptags | replace('\n', ' ') | trim %}
{% set meta_description = cleaned_description | truncate(200, True, '...') %}
{% set canonical_url = url_for('main.dataset_detail_by_slug_or_id', slug_or_id=dataset_identifier, _external=True) %}
{% set social_image = config.get('SOCIAL_IMAGE_URL') %}
<link rel="canonical" href="{{ canonical_url }}">
<meta name="description" content="{{ meta_description }}">
<meta name="robots" content="index,follow">
<meta property="og:site_name" content="Data.gov">
<meta property="og:type" content="article">
<meta property="og:url" content="{{ canonical_url }}">
<meta property="og:title" content="{{ page_title }}">
<meta property="og:description" content="{{ meta_description }}">
<meta property="og:image" content="{{ social_image }}">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:url" content="{{ canonical_url }}">
<meta name="twitter:title" content="{{ page_title }}">
<meta name="twitter:description" content="{{ meta_description }}">
<meta name="twitter:image" content="{{ social_image }}">
{% endblock %}

{% block main_content %}
{% set distributions = dataset.dcat.get('distribution') %}
{% set description_value = dataset.dcat.get('description') %}

<div class="usa-section">
    <div class="grid-container-widescreen">

        <!-- Return to search link -->
        {% if from_dict %}
        <a href="{{ url_for('main.index', **from_dict) }}" class="return-link">
            <i class="fa-solid fa-arrow-left"></i>
            Return to search results
        </a>
        {% endif %}

        <div class="grid-row grid-gap-lg">
            <!-- Main Content Column -->
            <div class="desktop:grid-col-8">

                <!-- Title and Metadata -->
                <h1 class="dataset-title">{{ dataset_title }}</h1>

                <div class="dataset-meta">
                    {% if dataset.dcat.get('publisher', {}).get('name') %}
                    Published by <strong>{{ dataset.dcat.publisher.name }}</strong>
                    {% endif %}
                    {% if organization %}
                    {% if dataset.dcat.get('publisher', {}).get('name') %} | {% endif %}
                    <a href="{{ url_for('main.organization_detail', slug=organization.slug) }}">{{ organization.name
                        }}</a>
                    {% endif %}
                    {% if dataset.last_harvested_date %}
                    | Metadata Last Checked: <strong>{{ dataset.last_harvested_date.strftime('%B %d, %Y') }}</strong>
                    {% endif %}
                    {% if dataset.dcat.get('modified') %}
                    | Last Modified: <strong>{{ dataset.dcat.modified }}</strong>
                    {% endif %}
                </div>

                <!-- Description -->
                {% if description_value %}
                <div class="dataset-description">
                    {{ description_value | remove_html_tags | format_dcat_value }}
                </div>
                {% else %}
                <p class="dataset-description text-base-light">No description available</p>
                {% endif %}

                <!-- Resources -->
                {% if distributions %}
                {% set resource_items = distributions %}
                {% if resource_items is mapping or resource_items is string %}
                {% set resource_items = [resource_items] %}
                {% elif resource_items is not sequence %}
                {% set resource_items = [resource_items] %}
                {% endif %}

                <div class="resources-section">
                    <h2 class="text-primary-darker margin-bottom-1">Resources</h2>
                    <p class="resources-label margin-top-0">
                        {{ resource_items|length }} resource{{ 's' if resource_items|length != 1 else '' }} available
                    </p>

                    <ul class="resources-list resources-list--main">
                        {% for resource in resource_items %}
                        {% set download_url = None %}
                        {% set access_url = None %}
                        {% set resource_title = 'Resource ' ~ loop.index %}
                        {% set resource_format = 'FILE' %}

                        {% if resource is mapping %}
                        {% set download_url = resource.get('downloadURL') %}
                        {% set access_url = resource.get('accessURL') %}
                        {% set resource_title = resource.get('title') or resource.get('description') or 'Resource ' ~
                        loop.index %}
                        {% set resource_format = (resource.get('format') or resource.get('mediaType') or 'file')|upper
                        %}
                        {% endif %}

                        <li class="resources-list__item resources-list__item--main">
                            <div class="resources-list__info">
                                <div class="resources-list__icon">
                                    <i class="{{ resource_format|fa_icon_from_extension }} fa-solid"></i>
                                </div>
                                <div class="resources-list__details">
                                    <p class="resources-list__name" title="{{ resource_title }}">
                                        {{ resource_title }}
                                    </p>
                                    <div class="resources-list__format">{{ resource_format }}</div>
                                </div>
                            </div>
                            <div class="resources-list__actions">
                                {% if download_url %}
                                <a href="{{ download_url }}" target="_blank" rel="noopener"
                                    class="usa-button usa-button--small resources-list__btn"
                                    aria-label="Download {{ resource_title }}">
                                    <i class="fa-solid fa-download margin-right-05"></i>
                                    Download
                                </a>
                                {% endif %}
                                {% if access_url %}
                                <a href="{{ access_url }}" target="_blank" rel="noopener"
                                    class="usa-button usa-button--outline usa-button--small resources-list__btn"
                                    aria-label="Visit page for {{ resource_title }}">
                                    <i class="fa-solid fa-arrow-up-right-from-square margin-right-05"></i>
                                    Visit Page
                                </a>
                                {% endif %}
                                {% if not download_url and not access_url %}
                                <span class="text-base-light font-sans-xs">No link available</span>
                                {% endif %}
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Tags as Search Actions -->
                {% if dataset.dcat.get('keyword') %}
                <div class="tags-section">
                    <h3 class="tags-section__heading">Find Related Datasets</h3>
                    <p class="tags-section__subtitle">Click any tag below to search for similar datasets</p>
                    <div>
                        {% for keyword in dataset.dcat.keyword %}
                        <a href="{{ url_for('main.index', q=keyword) }}" class="tag-link">
                            {{ keyword }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- <h2 class="text-primary-darker margin-bottom-2">Complete Metadata</h2> -->

                <details>
                    <summary>
                        <h2 class="complete-metadata-heading">Complete Metadata</h2>
                    </summary>
                    <!-- Complete Metadata -->
                    <section class="margin-top-4">
                        <table class="metadata-table">
                            <tbody>
                                {% for key, value in dataset.dcat|dictsort %}
                                {% set rendered_value = value|format_dcat_value %}
                                <tr>
                                    <th scope="row">{{ key }}</th>
                                    <td>
                                        {% if rendered_value | is_json %}
                                        <pre class="json">
                                            {{ value | json_to_semantic_html | safe }}
                                        </pre>
                                        {% else %}
                                        {{ rendered_value }}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </section>
                </details>
            </div>

            <!-- Sidebar -->
            <aside class="desktop:grid-col-4">

                <!-- Contact Information -->
                {% if dataset.dcat.get('contactPoint') %}
                <div class="sidebar-section">
                    <h3 class="sidebar-section__heading">Contact</h3>

                    {% if dataset.dcat.contactPoint.get('fn') %}
                    <div class="sidebar-section__item">
                        <div class="sidebar-section__label">Name</div>
                        <div class="sidebar-section__value">{{ dataset.dcat.contactPoint.fn }}</div>
                    </div>
                    {% endif %}

                    {% if dataset.dcat.contactPoint.get('hasEmail') %}
                    {% set email = dataset.dcat.contactPoint.get('hasEmail') | format_contact_point_email%}
                    <div class="sidebar-section__item">
                        <div class="sidebar-section__label">Email</div>
                        <div class="sidebar-section__value">
                            <a href="mailto:{{ email }}">
                                {{ email}}
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Access and Use Information -->
                <div class="sidebar-section">
                    <h3 class="sidebar-section__heading">Access & Use</h3>

                    {% if dataset.dcat.get('license') %}
                    <div class="sidebar-section__item">
                        <div class="sidebar-section__label">License</div>
                        <div class="sidebar-section__value">{{ dataset.dcat.license }}</div>
                    </div>
                    {% endif %}

                    {% if dataset.dcat.get('accessLevel') %}
                    <div class="sidebar-section__item">
                        <div class="sidebar-section__label">Access Level</div>
                        <div class="sidebar-section__value">{{ dataset.dcat.accessLevel }}</div>
                    </div>
                    {% endif %}
                </div>

                <!-- Dataset Information -->
                <div class="sidebar-section">
                    <h3 class="sidebar-section__heading">Dataset Information</h3>

                    {% if dataset.dcat.get('issued') %}
                    <div class="sidebar-section__item">
                        <div class="sidebar-section__label">Dataset Issued</div>
                        <div class="sidebar-section__value">
                            {{ dataset.dcat.get('issued') }}
                        </div>
                    </div>
                    {% endif %}

                    {% if dataset.dcat.get('modified') %}
                    <div class="sidebar-section__item">
                        <div class="sidebar-section__label">Dataset Last Modified</div>
                        <div class="sidebar-section__value">
                            {{ dataset.dcat.get('modified') }}
                        </div>
                    </div>
                    {% endif %}

                    {% if dataset.dcat.get('accrualPeriodicity') %}
                    <div class="sidebar-section__item">
                        <div class="sidebar-section__label">Accrual Periodicity</div>
                        <div class="sidebar-section__value">
                            {{ dataset.dcat.get('accrualPeriodicity') }}
                        </div>
                    </div>
                    {% endif %}


                    {% set spatial_shape = dataset.translated_spatial %}
                    {% if spatial_shape %}
                    <div class="margin-top-3">
                        <p class="margin-0"><strong>Location</strong></p>
                        <div id="dataset-map" class="map-container"
                            data-geometry='{{ spatial_shape | tojson | forceescape }}'></div>
                    </div>
                    {% endif %}
                </div>


                <!-- Metadata Information -->
                <div class="sidebar-section">
                    <h3 class="sidebar-section__heading">Metadata Information</h3>

                    {% if dataset.last_harvested_date %}
                    <div class="sidebar-section__item">
                        <div class="sidebar-section__label">Metadata Last Checked</div>
                        <div class="sidebar-section__value">
                            {{ dataset.last_harvested_date.strftime('%B %d, %Y at %I:%M %p') }}
                        </div>
                    </div>
                    {% endif %}

                    {% if dataset.harvest_record_id %}
                    <div class="sidebar-section__item">
                        <div class="sidebar-section__label">Harvest Record</div>
                        <div class="sidebar-section__value">
                            <a href="{{ url_for('main.get_harvest_record_raw', record_id=dataset.harvest_record_id) }}">
                                View Raw Data
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Feedback -->
                <div class="sidebar-section">
                    <h3 class="sidebar-section__heading">Provide Feedback</h3>
                    <p class="dataset-feedback">
                        Have questions or suggestions about this dataset?
                    </p>
                    <button class="usa-button width-full" type="button" id="contact-btn"
                        data-dataset-identifier="{{ dataset_identifier }}" data-dataset-title="{{ dataset_title }}"
                        aria-label="Provide feedback on {{ dataset_title }}">
                        <i class="fa-solid fa-comment-dots margin-right-05"></i>
                        Send Feedback
                    </button>
                </div>

            </aside>
        </div>
    </div>
</div>
{% endblock main_content %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/dataset_feedback.js') }}"></script>
{% if dataset.translated_spatial %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/vendor/leaflet.css') }}" />
<script src="{{ url_for('static', filename='js/vendor/leaflet.js') }}"></script>
<script src="{{ url_for('static', filename='js/view_bbox_map.js') }}"></script>
</script>
{% endif %}
{% endblock %}