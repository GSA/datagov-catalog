---
name: Create Sitemaps

on:
  schedule:
    - cron: '0 5 * * *'
  workflow_dispatch:
    inputs:
      environ:
        description: 'Environment:'
        required: true
        type: choice
        default: development
        options:
          - development

permissions:
  contents: read

jobs:
  sitemap-tasks:
    name: Generate and Verify Sitemap
    runs-on: ubuntu-latest
    environment: ${{ env.CF_SPACE }}
    env:
      CF_SPACE: ${{ github.event.inputs.environ || 'development' }}
    steps:
      - name: checkout
        uses: actions/checkout@v5
      - name: Store task instance names
        run: |
          echo "GEN_INSTANCE_NAME=sitemap-generate-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}" >> $GITHUB_ENV
          echo "VER_INSTANCE_NAME=sitemap-verify-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}" >> $GITHUB_ENV
      - name: Run sitemap generate task
        uses: cloud-gov/cg-cli-tools@main
        with:
          cf_org: gsa-datagov
          cf_space: ${{ env.CF_SPACE }}
          cf_username: ${{ secrets.CF_SERVICE_USER }}
          cf_password: ${{ secrets.CF_SERVICE_AUTH }}
          command: >
            cf run-task datagov-catalog --command "flask sitemap generate" --name "$GEN_INSTANCE_NAME"
      - name: Monitor generate task output
        uses: cloud-gov/cg-cli-tools@main
        with:
          cf_org: gsa-datagov
          cf_space: ${{ env.CF_SPACE }}
          cf_username: ${{ secrets.CF_SERVICE_USER }}
          cf_password: ${{ secrets.CF_SERVICE_AUTH }}
          command: >
            bash tools/monitor_cf_logs.sh datagov-catalog "$GEN_INSTANCE_NAME"
      - name: Run sitemap verify task
        uses: cloud-gov/cg-cli-tools@main
        with:
          cf_org: gsa-datagov
          cf_space: ${{ env.CF_SPACE }}
          cf_username: ${{ secrets.CF_SERVICE_USER }}
          cf_password: ${{ secrets.CF_SERVICE_AUTH }}
          command: >
            cf run-task datagov-catalog --command "flask sitemap verify" --name "$VER_INSTANCE_NAME"
      - name: Monitor verify task output
        uses: cloud-gov/cg-cli-tools@main
        with:
          cf_org: gsa-datagov
          cf_space: ${{ env.CF_SPACE }}
          cf_username: ${{ secrets.CF_SERVICE_USER }}
          cf_password: ${{ secrets.CF_SERVICE_AUTH }}
          command: >
            bash tools/monitor_cf_logs.sh datagov-catalog "$VER_INSTANCE_NAME"
