name: Deploy
on:
  push:
    branches:
      - main

permissions:
  contents: read

env:
  PY_VERSION: "3.12"
  POETRY_VERSION: "latest"

jobs:
  lint:
    runs-on: ubuntu-latest
    name: Python Lint
    steps:
      - uses: actions/checkout@v4
      - uses: chartboost/ruff-action@v1

  deploy-staging:
    name: deploy to staging space
    environment: staging
    runs-on: ubuntu-latest
    steps:
      - name: Check out the code
        uses: actions/checkout@v4
      - name: Deploy via composite action
        uses: ./.github/actions/deploy
        with:
          cf_space: staging
          python-version: ${{ env.PY_VERSION }}
          poetry-version: ${{ env.POETRY_VERSION }}
          cf_username: ${{ secrets.CF_SERVICE_USER }}
          cf_password: ${{ secrets.CF_SERVICE_AUTH }}
          smoke-url: https://datagov-catalog-staging.app.cloud.gov/
          smoke-path: /
          basic_auth_user: ${{ secrets.BASIC_AUTH_USER }}
          basic_auth_password: ${{ secrets.BASIC_AUTH_PASSWORD }}

  deploy-prod:
    name: deploy to prod space
    environment: prod
    needs: deploy-staging
    runs-on: ubuntu-latest
    steps:
      - name: Check out the code
        uses: actions/checkout@v4
      - name: Deploy via composite action
        uses: ./.github/actions/deploy
        with:
          cf_space: prod
          python-version: ${{ env.PY_VERSION }}
          poetry-version: ${{ env.POETRY_VERSION }}
          cf_username: ${{ secrets.CF_SERVICE_USER }}
          cf_password: ${{ secrets.CF_SERVICE_AUTH }}
          smoke-url: https://catalog-beta.data.gov/
          smoke-path: /
          # basic auth on prod is turned off
