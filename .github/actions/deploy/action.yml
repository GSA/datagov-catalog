name: "Deploy datagov-catalog"
description: "Build assets, export dependencies, and deploy to Cloud.gov"

inputs:
  cf_space:
    description: "Cloud Foundry space (development, staging, production)"
    required: true
  cf_org:
    description: "Cloud Foundry org"
    required: false
    default: "gsa-datagov"
  command:
    description: "cf command to execute"
    required: false
    default: "cf push datagov-catalog --strategy rolling --no-wait"
  node-version-file:
    description: "Path to node version file"
    required: false
    default: "app/static/package.json"
  python-version:
    description: "Python version to use"
    required: false
    default: "3.12"
  poetry-version:
    description: "Poetry version to use"
    required: false
    default: "latest"
  cf_username:
    description: "Cloud Foundry service user"
    required: true
  cf_password:
    description: "Cloud Foundry service auth"
    required: true
  smoke-url:
    description: "Base URL for smoke test (set per environment)"
    required: false
    default: ""
  smoke-path:
    description: "Path to hit for smoke test"
    required: false
    default: "/"
  smoke-retries:
    description: "Number of retries for smoke test"
    required: false
    default: "20"
  smoke-delay-seconds:
    description: "Delay between retries (seconds)"
    required: false
    default: "5"
  smoke-timeout-seconds:
    description: "Single request timeout (seconds)"
    required: false
    default: "10"
  basic_auth_user:
    description: "basic auth username"
    required: true
  basic_auth_password:
    description: "basic auth password"
    required: true

runs:
  using: "composite"
  steps:
    - name: checkout
      uses: actions/checkout@v4

    - name: Install node.js
      uses: actions/setup-node@v4
      with:
        node-version-file: ${{ inputs.node-version-file }}

    - name: Build static assets
      shell: bash
      run: make install-static

    - name: Set up Python ${{ inputs.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}

    - name: Install Poetry
      uses: abatilo/actions-poetry@v3
      with:
        poetry-version: ${{ inputs.poetry-version }}
        poetry-plugins: "poetry-plugin-export"

    - name: Add requirements.txt
      shell: bash
      run: make update-dependencies && cat requirements.txt

    - name: Deploy datagov-catalog app
      uses: cloud-gov/cg-cli-tools@main
      with:
        command: >-
          ${{ inputs.command }} --vars-file vars.${{ inputs.cf_space }}.yml
        cf_org: ${{ inputs.cf_org }}
        cf_space: ${{ inputs.cf_space }}
        cf_username: ${{ inputs.cf_username }}
        cf_password: ${{ inputs.cf_password }}

    - name: Deploy datagov-catalog proxy
      uses: cloud-gov/cg-cli-tools@main
      with:
        command: >-
          cf push datagov-catalog-proxy --strategy rolling --no-wait --vars-file vars.${{ inputs.cf_space }}.yml
        cf_org: ${{ inputs.cf_org }}
        cf_space: ${{ inputs.cf_space }}
        cf_username: ${{ inputs.cf_username }}
        cf_password: ${{ inputs.cf_password }}

    - name: Smoke test application
      if: ${{ inputs.smoke-url != '' }}
      shell: bash
      run: |
        set -euo pipefail
        base="${{ inputs.smoke-url }}"
        path="${{ inputs.smoke-path }}"
        retries=${{ inputs.smoke-retries }}
        delay=${{ inputs.smoke-delay-seconds }}
        timeout=${{ inputs.smoke-timeout-seconds }}
        url="${base%/}${path}"
        echo "Starting smoke test: $url"
        for i in $(seq 1 "$retries"); do
          status=$(curl -u ${{ inputs.basic_auth_user }}:${{ inputs.basic_auth_password }} -s -o /dev/null -w "%{http_code}" --max-time "$timeout" "$url" || echo "000")
          echo "Attempt $i/$retries -> HTTP $status"
          if [ "$status" -ge 200 ] && [ "$status" -lt 400 ]; then
            echo "Smoke test passed."
            exit 0
          fi
          sleep "$delay"
        done
        echo "Smoke test FAILED for $url"
        exit 1
